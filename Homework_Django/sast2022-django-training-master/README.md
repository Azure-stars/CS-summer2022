# 科协暑培Django作业说明

> by 郑友捷  2021010771

本仓库存放科协Django作业相关文件，用Django实现了$leaderboard$后端的初步构建。该项目可在本地运行，也已部署至[http://59.66.131.240:45409](http://59.66.131.240:45409/)。

样例前端：http://front.sast2022.lmd.red/。可在其上进行前后端的简单对接。

## 后端API接口说明

### 排行榜

```
[GET] /leaderboard
```

该接口给出全部排行榜信息，先按照按照 `score` 降序排列，`score` 一样的，按照提交时间 `time` 升序排列。

对于用户的多次提交，无论分数高低，只返回最后一次提交。

#### 响应

```json
[

    {

        "user": "lambda_x",

        "score": 33,

        "subs": [22, 45, 32],

        "time": 1658419888,

        "avatar": "XXXXX"

    },

    {

        "user": "lambda_y",

        "score": 0,

        "subs": [1, 0, 0],

        "time": 1658419999,

        "avatar": "XXXXX"

    },

     ...

]
```

### 提交历史

```
[GET] /history/<user>
```

该接口提供指定用户的提交历史，按照提交时间 `time` 升序排列

#### 请求参数

- 用户名称，从请求 URL 中获得。

#### 响应

该用户的全部历史提交信息。

```json
[

    {

        "score": 0.37,

        "subs": [1, 0, 0],

        "time": 1658419999

    },

    {

        "score": 99,

        "subs": [99, 99, 99],

        "time": 1658420008

    },

    ...

]
```

#### 部分非法情况与返回码说明

* 当查询用户不存在，则返回

```json
{
    "code":-1,

    "msg":"该用户不存在"
}
```

* 当用户存在但无提交记录，则返回

```json
{
    "code":-2,

    "msg":"该用户无提交记录"
}
```

**注**：返回码-2在当前后端框架并不会被使用，因为只有当用户进行提交时才会创建新用户，且后端框架不存在删除提交记录这一借口。

### 提交

```
[POST] /submit
```

该接口用于接受用户提交的内容，进行评判，然后更新 Leaderboard。

#### 请求体样例

接收到的请求形如

```json
{

    "user": "lambda_x",

    "avatar": "...",

    "content": "..."

}
```

| 字段      | 说明                         |

| ------- | -------------------------- |

| user    | 用户名                        |

| avatar  | 用 base64 编码的用户头像，可以直接视为字符串 |

| content | 用户提交的内容，一个字符串              |

#### 响应

响应主要包括两部分

- `code` 表示请求的状态，0 为成功，其他表示失败

- `msg` 表示请求的说明文字，可用于前端给用户提示

- `data` 前端可能用到的数据

当用户提交成功的内容合法时，返回以下内容

```json
{

    "code": 0,

    "msg": "提交成功",

    "data": {

        "leaderboard": [

         "// 与[排行榜]这一接口返回内容相同，为更新后的排行榜"

        ]

    }

}
```

#### 部分非法情况与返回码说明

当请求参数不全时，返回

```json
{

    "code": -1,

    "msg": "参数不全嘤嘤嘤"

}
```

当用户名长于 255 字符，返回

```json
{

    "code": -2,

    "msg": "你的名字太长啦"

}
```

当请求的 `avatar` 超过 100K 字符时，返回

```json
{

    "code": -3,

    "msg": "你的头像太大啦，是不是忘了压缩了",

}
```

当检测到用户提交的内容不合法时，返回

```json
{

    "code": -4,

    "msg": "..."

}
```

### 投票

```
[POST] /vote
```

#### 请求体样例

```json
{

    "user": "lambda_x"

}
```

| 字段   | 说明             |

| ---- | -------------- |

| user | 接收投票的用户，这里的用户名 |

此时该用户的 `vote` 数加 1。

为了防止刷票，我们象征性地

- 拒绝 User-Agent 不太合理的请求

#### 响应

若请求正常，则返回

```json
{

    "code": 0,

    "msg":"投票成功"

    "data": {

        "leaderboard": [

            "与[排行榜]这一接口返回内容相同，为更新后的排行榜"

        ]

    }

}
```

#### 部分非法情况与返回码说明

对于User-Agent不符合要求的请求，返回

```json
{

    "code": -1

}
```

若请求缺失用户名字段，则返回

```json
{

    "code":-2,

    "msg":"缺失user字段"

}
```

若请求用户名不存在，则返回

```json
{
    "code":-3,

    "msg":"投票用户不存在"
}
```
